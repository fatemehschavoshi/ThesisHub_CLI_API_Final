{% extends "base.html" %}
{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø³ØªØ§Ø¯ | ThesisHub{% endblock %}

{% block extra_css %}
<style>
  .stats-card h6 { font-weight: 600; }
  .section-title { margin-top:2rem; margin-bottom:1rem; }
  .form-text { font-size:.85rem; color:#6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø³ØªØ§Ø¯</h5>
  <span class="text-muted small">{{ prof.name }} ({{ prof.teacher_code }})</span>
</div>

<!-- Stats section -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</h6>
      <span class="badge text-bg-warning fs-6">{{ stats.pending }}</span>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</h6>
      <span class="badge text-bg-success fs-6">{{ stats.approved }}</span>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>Ø¯Ø± Ø¯ÙØ§Ø¹</h6>
      <span class="badge text-bg-info fs-6">{{ stats.defense }}</span>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>Ø¢Ø±Ø´ÛŒÙˆ</h6>
      <span class="badge text-bg-secondary fs-6">{{ stats.archived }}</span>
    </div>
  </div>
</div>

<!-- Export -->
<div class="mb-4">
  <a href="{{ url_for('prof_export_csv') if 'prof_export_csv' in globals() else '/prof/export.csv' }}" class="btn btn-sm btn-outline-primary">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ CSV</a>
</div>

<!-- Archive table -->
<div class="card p-3 mb-4">
  <h6 class="mb-3">Ø¢Ø±Ø´ÛŒÙˆ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø´Ø¯Ù‡</h6>
  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>Ø¯Ø§Ù†Ø´Ø¬Ùˆ</th>
          <th>Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø±Ø³</th>
          <th>Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ù†Ù…Ø±Ù‡</th>
          <th>Ø­Ø±Ù</th>
        </tr>
      </thead>
      <tbody>
        {% for a in archive %}
          <tr>
            <td>{{ a.student_code }}</td>
            <td>{{ a.course_id }}</td>
            <td>{{ a.title }}</td>
            <td>{{ "%.2f"|format(a.score) }}</td>
            <td>{{ a.grade_letter }}</td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">Ù…ÙˆØ±Ø¯ÛŒ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆ Ù†ÛŒØ³Øª.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Chart -->
<div class="card p-3 mb-5">
  <h6 class="mb-3">Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§</h6>
  <canvas id="chart" height="120"></canvas>
</div>

<!-- Requests management -->
<h6 class="section-title">Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</h6>
<div class="card p-3 mb-4">
  <form method="post" action="{{ url_for('prof_reject') }}" class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Ú©Ø¯ Ø¯Ø§Ù†Ø´Ø¬Ùˆ</label>
      <input name="student_code" class="form-control" required placeholder="S1001">
      <div class="invalid-feedback">Ú©Ø¯ Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø±Ø³</label>
      <input name="course_id" class="form-control" required placeholder="C3001">
      <div class="invalid-feedback">Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø±Ø³ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">Ø¯Ù„ÛŒÙ„ Ø±Ø¯</label>
      <input name="reason" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¸Ø±ÙÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø§Ø³Øª">
    </div>
    <div class="col-12 d-grid d-md-inline">
      <button class="btn btn-danger">Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
    </div>
  </form>
</div>

<!-- Defense schedule -->
<h6 class="section-title">Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¯ÙØ§Ø¹</h6>
<div class="card p-3 mb-4">
  <form method="post" action="{{ url_for('prof_schedule') }}" class="row g-3" id="scheduleForm">
    <div class="col-md-3">
      <label class="form-label">Ú©Ø¯ Ø¯Ø§Ù†Ø´Ø¬Ùˆ</label>
      <input name="student_code" class="form-control" required placeholder="S1001">
    </div>
    <div class="col-md-3">
      <label class="form-label">Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø±Ø³</label>
      <input name="course_id" class="form-control" required placeholder="C3001">
    </div>
    <div class="col-md-3">
      <label class="form-label">ØªØ§Ø±ÛŒØ® Ø¯ÙØ§Ø¹</label>
      <input name="defense_date" type="date" class="form-control" required id="defenseDate">
      <div class="form-text">ØªØ§Ø±ÛŒØ® Ø¨Ø§ÛŒØ¯ Ø§Ù…Ø±ÙˆØ² ÛŒØ§ Ø¢ÛŒÙ†Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.</div>
    </div>
    <div class="col-md-3">
      <label class="form-label">Ø¯Ø§ÙˆØ± Ø¯Ø§Ø®Ù„ÛŒ (Ú©Ø¯ Ø§Ø³ØªØ§Ø¯ÛŒ)</label>
      <input name="internal" class="form-control" required placeholder="Ù…Ø«Ø§Ù„: T2002">
      <div class="form-text">Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ Ø¯Ø§ÙˆØ±Ø§Ù† Ø¨Ø§ÛŒØ¯ Ù…Ø¬Ø²Ø§ Ø¨Ø§Ø´Ù†Ø¯.</div>
    </div>
    <div class="col-md-3">
      <label class="form-label">Ø¯Ø§ÙˆØ± Ø®Ø§Ø±Ø¬ÛŒ (Ú©Ø¯ Ø§Ø³ØªØ§Ø¯ÛŒ)</label>
      <input name="external" class="form-control" required placeholder="Ù…Ø«Ø§Ù„: T2003">
    </div>
    <div class="col-12 d-grid d-md-inline">
      <button class="btn btn-success">Ø«Ø¨Øª Ø²Ù…Ø§Ù† Ø¯ÙØ§Ø¹</button>
    </div>
  </form>
</div>

<!-- Finalize defense -->
<h6 class="section-title">Ù†Ù‡Ø§ÛŒÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø¯ÙØ§Ø¹</h6>
<div class="card p-3 mb-4">
  <form method="post" action="{{ url_for('prof_finalize') }}" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Ú©Ø¯ Ø¯Ø§Ù†Ø´Ø¬Ùˆ</label>
      <input name="student_code" class="form-control" required placeholder="S1001">
    </div>
    <div class="col-md-3">
      <label class="form-label">Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø±Ø³</label>
      <input name="course_id" class="form-control" required placeholder="C3001">
    </div>
    <div class="col-md-6">
      <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡</label>
      <input name="title" class="form-control" required placeholder="Ø¹Ù†ÙˆØ§Ù† Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡">
    </div>
    <div class="col-md-2">
      <label class="form-label">Ø³Ø§Ù„</label>
      <input name="year" type="number" class="form-control" required placeholder="1404" min="1300" max="1600">
    </div>
    <div class="col-md-2">
      <label class="form-label">Ù†ÛŒÙ…Ø³Ø§Ù„</label>
      <select name="semester" class="form-select" required>
        <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
        <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Ø­Ø§Ø¶Ø±ÛŒÙ†</label>
      <input name="attendees" class="form-control" placeholder="Ú©Ø¯Ù‡Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§: S1001, T2001, T2002">
      <div class="form-text">Ø¨Ø±Ø§ÛŒ ØµÙˆØ±ØªØ¬Ù„Ø³Ù‡ PDF Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">Ù†ØªÛŒØ¬Ù‡</label>
      <select name="result" class="form-select">
        <option value="defense">Ø¯ÙØ§Ø¹</option>
        <option value="re-defense">Ø¯ÙØ§Ø¹ Ù…Ø¬Ø¯Ø¯</option>
      </select>
    </div>
    <div class="col-12 d-grid d-md-inline">
      <button class="btn btn-primary">Ù†Ù‡Ø§ÛŒÛŒâ€ŒØ³Ø§Ø²ÛŒ</button>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js (Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Chart.js config
  (function () {
    const el = document.getElementById('chart');
    if (!el || !window.Chart) return;
    const data = {
      labels: ['Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±','ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡','Ø¯Ø± Ø¯ÙØ§Ø¹','Ø¢Ø±Ø´ÛŒÙˆ'],
      datasets: [{
        label: 'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§',
        data: [{{ stats.pending }}, {{ stats.approved }}, {{ stats.defense }}, {{ stats.archived }}],
        backgroundColor: ['#ffc107','#198754','#0dcaf0','#6c757d']
      }]
    };
    new Chart(el, { type:'bar', data, options:{responsive:true, plugins:{legend:{display:false}}} });
  })();

  // Min date = Ø§Ù…Ø±ÙˆØ² Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯ ØªØ§Ø±ÛŒØ® Ø¯ÙØ§Ø¹
  (function () {
    const d = document.getElementById('defenseDate');
    if (!d) return;
    const now = new Date();
    const y = now.getFullYear();
    const m = (now.getMonth()+1).toString().padStart(2,'0');
    const day = now.getDate().toString().padStart(2,'0');
    d.min = `${y}-${m}-${day}`;
  })();
</script>
{% endblock %}
