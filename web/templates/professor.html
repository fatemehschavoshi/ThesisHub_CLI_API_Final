{% extends "base.html" %}
{% block title %}داشبورد استاد | ThesisHub{% endblock %}

{% block extra_css %}
<style>
  .stats-card h6 { font-weight: 600; }
  .section-title { margin-top:2rem; margin-bottom:1rem; }
  .form-text { font-size:.85rem; color:#6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">داشبورد استاد</h5>
  <span class="text-muted small">{{ prof.name }} ({{ prof.teacher_code }})</span>
</div>

<!-- Stats section -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>در انتظار</h6>
      <span class="badge text-bg-warning fs-6">{{ stats.pending }}</span>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>تایید شده</h6>
      <span class="badge text-bg-success fs-6">{{ stats.approved }}</span>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>در دفاع</h6>
      <span class="badge text-bg-info fs-6">{{ stats.defense }}</span>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center p-3 stats-card">
      <h6>آرشیو</h6>
      <span class="badge text-bg-secondary fs-6">{{ stats.archived }}</span>
    </div>
  </div>
</div>

<!-- Export -->
<div class="mb-4">
  <a href="{{ url_for('prof_export_csv') if 'prof_export_csv' in globals() else '/prof/export.csv' }}" class="btn btn-sm btn-outline-primary">📥 خروجی CSV</a>
</div>

<!-- Archive table -->
<div class="card p-3 mb-4">
  <h6 class="mb-3">آرشیو پایان‌نامه‌های راهنمایی شده</h6>
  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>دانشجو</th>
          <th>شناسه درس</th>
          <th>عنوان</th>
          <th>نمره</th>
          <th>حرف</th>
        </tr>
      </thead>
      <tbody>
        {% for a in archive %}
          <tr>
            <td>{{ a.student_code }}</td>
            <td>{{ a.course_id }}</td>
            <td>{{ a.title }}</td>
            <td>{{ "%.2f"|format(a.score) }}</td>
            <td>{{ a.grade_letter }}</td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">موردی در آرشیو نیست.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Chart -->
<div class="card p-3 mb-5">
  <h6 class="mb-3">نمودار وضعیت پایان‌نامه‌ها</h6>
  <canvas id="chart" height="120"></canvas>
</div>

<!-- Requests management -->
<h6 class="section-title">مدیریت درخواست‌ها</h6>
<div class="card p-3 mb-4">
  <form method="post" action="{{ url_for('prof_reject') }}" class="row g-3">
    <div class="col-md-4">
      <label class="form-label">کد دانشجو</label>
      <input name="student_code" class="form-control" required placeholder="S1001">
      <div class="invalid-feedback">کد دانشجو الزامی است.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">شناسه درس</label>
      <input name="course_id" class="form-control" required placeholder="C3001">
      <div class="invalid-feedback">شناسه درس الزامی است.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">دلیل رد</label>
      <input name="reason" class="form-control" placeholder="مثال: ظرفیت تکمیل است">
    </div>
    <div class="col-12 d-grid d-md-inline">
      <button class="btn btn-danger">رد درخواست</button>
    </div>
  </form>
</div>

<!-- Defense schedule -->
<h6 class="section-title">زمان‌بندی دفاع</h6>
<div class="card p-3 mb-4">
  <form method="post" action="{{ url_for('prof_schedule') }}" class="row g-3" id="scheduleForm">
    <div class="col-md-3">
      <label class="form-label">کد دانشجو</label>
      <input name="student_code" class="form-control" required placeholder="S1001">
    </div>
    <div class="col-md-3">
      <label class="form-label">شناسه درس</label>
      <input name="course_id" class="form-control" required placeholder="C3001">
    </div>
    <div class="col-md-3">
      <label class="form-label">تاریخ دفاع</label>
      <input name="defense_date" type="date" class="form-control" required id="defenseDate">
      <div class="form-text">تاریخ باید امروز یا آینده باشد.</div>
    </div>
    <div class="col-md-3">
      <label class="form-label">داور داخلی (کد استادی)</label>
      <input name="internal" class="form-control" required placeholder="مثال: T2002">
      <div class="form-text">راهنما و داوران باید مجزا باشند.</div>
    </div>
    <div class="col-md-3">
      <label class="form-label">داور خارجی (کد استادی)</label>
      <input name="external" class="form-control" required placeholder="مثال: T2003">
    </div>
    <div class="col-12 d-grid d-md-inline">
      <button class="btn btn-success">ثبت زمان دفاع</button>
    </div>
  </form>
</div>

<!-- Finalize defense -->
<h6 class="section-title">نهایی‌سازی دفاع</h6>
<div class="card p-3 mb-4">
  <form method="post" action="{{ url_for('prof_finalize') }}" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">کد دانشجو</label>
      <input name="student_code" class="form-control" required placeholder="S1001">
    </div>
    <div class="col-md-3">
      <label class="form-label">شناسه درس</label>
      <input name="course_id" class="form-control" required placeholder="C3001">
    </div>
    <div class="col-md-6">
      <label class="form-label">عنوان پایان‌نامه</label>
      <input name="title" class="form-control" required placeholder="عنوان نهایی پایان‌نامه">
    </div>
    <div class="col-md-2">
      <label class="form-label">سال</label>
      <input name="year" type="number" class="form-control" required placeholder="1404" min="1300" max="1600">
    </div>
    <div class="col-md-2">
      <label class="form-label">نیمسال</label>
      <select name="semester" class="form-select" required>
        <option value="اول">اول</option>
        <option value="دوم">دوم</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">حاضرین</label>
      <input name="attendees" class="form-control" placeholder="کدها با کاما: S1001, T2001, T2002">
      <div class="form-text">برای صورتجلسه PDF ثبت می‌شود.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">نتیجه</label>
      <select name="result" class="form-select">
        <option value="defense">دفاع</option>
        <option value="re-defense">دفاع مجدد</option>
      </select>
    </div>
    <div class="col-12 d-grid d-md-inline">
      <button class="btn btn-primary">نهایی‌سازی</button>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js (برای نمودار) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Chart.js config
  (function () {
    const el = document.getElementById('chart');
    if (!el || !window.Chart) return;
    const data = {
      labels: ['در انتظار','تایید شده','در دفاع','آرشیو'],
      datasets: [{
        label: 'تعداد پایان‌نامه‌ها',
        data: [{{ stats.pending }}, {{ stats.approved }}, {{ stats.defense }}, {{ stats.archived }}],
        backgroundColor: ['#ffc107','#198754','#0dcaf0','#6c757d']
      }]
    };
    new Chart(el, { type:'bar', data, options:{responsive:true, plugins:{legend:{display:false}}} });
  })();

  // Min date = امروز برای فیلد تاریخ دفاع
  (function () {
    const d = document.getElementById('defenseDate');
    if (!d) return;
    const now = new Date();
    const y = now.getFullYear();
    const m = (now.getMonth()+1).toString().padStart(2,'0');
    const day = now.getDate().toString().padStart(2,'0');
    d.min = `${y}-${m}-${day}`;
  })();
</script>
{% endblock %}
